version: "3"

tasks:
  install:
    desc: Install dependencies
    cmds:
      - pnpm install

  dev:
    desc: Start development server
    cmds:
      - pnpm dev

  tsc:
    desc: Type check
    cmds:
      - pnpm tsc --noEmit

  lint:
    desc: Run ESLint
    cmds:
      - pnpm lint

  format:
    desc: Format code with Prettier
    cmds:
      - pnpm format

  format:check:
    desc: Check code formatting
    cmds:
      - pnpm format:check

  test:ct:install:
    desc: Install Playwright browsers
    cmds:
      - pnpm exec playwright install --with-deps chromium

  test:ct:
    desc: Run component tests
    cmds:
      - pnpm test:ct

  test:ct:ui:
    desc: Run component tests with UI
    cmds:
      - pnpm exec playwright test -c playwright-ct.config.ts --ui

  test:unit:
    desc: Run unit tests
    cmds:
      - pnpm test:unit

  build:
    desc: Build the project
    cmds:
      - pnpm build

  knip:
    desc: Find unused code
    cmds:
      - pnpm exec knip

  check:
    desc: Run all checks (tsc, lint, format, tests)
    cmds:
      - task: tsc
      - task: lint
      - task: format:check
      - task: test:unit
      - task: test:ct

  ngrok:
    desc: Expose local dev server via ngrok
    cmds:
      - ngrok http 5173

  security:
    desc: Run trivy security scan
    cmds:
      - trivy fs --ignorefile .trivyignore.yaml --skip-version-check .

  secrets:
    desc: Scan for secrets with gitleaks
    cmds:
      - gitleaks detect --source . -v

  update-screenshots:
    aliases:
      - us
    desc: Update screenshots using Docker (for consistent rendering)
    vars:
      PLAYWRIGHT_VERSION:
        sh: jq -r '.devDependencies."@playwright/experimental-ct-react"' package.json
    cmds:
      - >-
        docker run --rm
        -e CI=true
        -v $(pwd):$(pwd)
        -w $(pwd)
        mcr.microsoft.com/playwright:v{{.PLAYWRIGHT_VERSION}}-jammy
        sh -c "corepack enable && pnpm install --no-frozen-lockfile && pnpm test:ct --update-snapshots"

  update-screenshots-ci:
    aliases:
      - us-ci
    desc: Trigger GitHub Actions workflow to update snapshots
    cmds:
      - gh workflow run update-snapshots.yml --ref main

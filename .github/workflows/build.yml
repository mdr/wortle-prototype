name: Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if update screenshots mode
        id: check-us
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ "$COMMIT_MSG" == US* ]]; then
            echo "update_screenshots=true" >> $GITHUB_OUTPUT
          else
            echo "update_screenshots=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup devShell
        uses: nicknovitski/nix-develop@v1

      - name: Install dependencies
        run: task install

      - name: Install infra dependencies
        run: task infra:install

      - name: Type check
        run: task tsc

      - name: Type check infra
        run: task infra:tsc

      - name: Lint
        run: task lint

      - name: Check formatting
        run: task format:check

      - name: Install Playwright browsers
        run: task test:ct:install

      - name: Component tests
        id: test-ct
        run: task test:ct
        continue-on-error: ${{ steps.check-us.outputs.update_screenshots == 'true' }}

      - name: Update snapshots if tests failed
        if: steps.check-us.outputs.update_screenshots == 'true' && steps.test-ct.outcome == 'failure'
        run: pnpm test:ct --update-snapshots

      - name: Commit updated snapshots
        if: steps.check-us.outputs.update_screenshots == 'true' && steps.test-ct.outcome == 'failure'
        run: |
          git add src/tests/playwright/snapshots
          if git diff --staged --quiet; then
            echo "No snapshot changes to commit"
          else
            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'
            git commit -m "Update component test snapshots"
            git push
          fi

      - name: Re-run component tests after snapshot update
        if: steps.check-us.outputs.update_screenshots == 'true' && steps.test-ct.outcome == 'failure'
        run: task test:ct

      - name: Upload Playwright report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Build
        run: task build

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
